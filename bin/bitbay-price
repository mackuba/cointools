#!/usr/bin/env ruby

require 'bundler/setup'
require 'cointools'

require 'optparse'
require 'time'

def print_help
  puts "Usage: #{$PROGRAM_NAME} <market> [-v/--verbose]"
  puts " e.g.: #{$PROGRAM_NAME} btcusd"
end

verbose = false

OptionParser.new do |opts|
  opts.on('-v', '--verbose') { verbose = true }

  opts.on('-h', '--help') do
    print_help
    exit 0
  end

  opts.parse!
end

if ARGV.length != 1
  print_help
  exit 1
end

market = ARGV[0].downcase

begin
  result = CoinTools::BitBay.new.get_price(market)

  if verbose
    puts "#{market.upcase} @ #{Time.now} ==> #{result.price}"
    puts
  else
    puts result.price
  end
rescue CoinTools::BitBay::ErrorResponseException => e
  $stderr.puts "Error: #{e}"
  exit 2
rescue CoinTools::BitBay::BadRequestException => e
  $stderr.puts "Error: Incorrect market name (#{e})"
  exit 3
end
