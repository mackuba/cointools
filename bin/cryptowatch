#!/usr/bin/env ruby

require 'bundler/setup'
require 'cointools'

require 'time'

if ARGV.length < 2
  puts "Usage: #{$PROGRAM_NAME} <exchange> <market> [<date>] [-v/--verbose]"
  puts " e.g.: #{$PROGRAM_NAME} gdax btcusd \"2017-06-30 15:27\""
  exit 1
end

exchange = ARGV[0].downcase
market = ARGV[1].downcase
date = Time.parse(ARGV[2]) if ARGV[2] && !ARGV[2].start_with?('-')
verbose = ARGV.last == '-v' || ARGV.last == '--verbose'

begin
  result = CoinTools::Cryptowatch.new.get_price(exchange, market, date)

  if verbose
    puts "#{exchange}:#{market} @ #{result.time} ==> #{result.price}"
    puts
  else
    puts result.price
  end
rescue CoinTools::Cryptowatch::InvalidDateException => e
  $stderr.puts "Error: #{e}"
  exit 2
rescue CoinTools::Cryptowatch::BadRequestException => e
  $stderr.puts "Error: Incorrect exchange or market name: #{e}"
  exit 3
rescue CoinTools::Cryptowatch::NoDataException => e
  $stderr.puts "Error: #{e}: data not ready yet"
  exit 4
end
